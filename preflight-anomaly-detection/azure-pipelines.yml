trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'
    addToPath: true
  displayName: 'Use Python 3.11'

- script: |
    echo "Verify python version"
    python --version
    pip --version
  displayName: 'Verify Python installation'

- script: |
    echo "Creating virtual environment..."
    python -m venv .venv
    source .venv/bin/activate
    echo "Installing dependencies..."
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    pip install pytest pytest-cov
  displayName: 'Create Virtual Environment and Install Dependencies'

- script: |
    source .venv/bin/activate
    python train_model.py
  displayName: 'Train Model'

- script: |
    source .venv/bin/activate
    echo "Verifying data and model..."
    python -c "
import pandas as pd
import os
from pathlib import Path

data_file = Path('airplane_data.csv')
if not data_file.exists():
    raise Exception(f'Data file not found: {data_file}')

df = pd.read_csv(data_file)
required_columns = ['rpm', 'temperature', 'pressure', 'voltage']
missing_columns = [col for col in required_columns if col not in df.columns]
if missing_columns:
    raise Exception(f'Missing required columns in data: {missing_columns}')

model_dir = Path('models')
if not model_dir.exists():
    raise Exception('Models directory not found')

model_file = model_dir / 'isolation_forest_model.pkl'
if not model_file.exists():
    raise Exception(f'Model file not found: {model_file}')
print('Data and model verification successful!')
"
  displayName: 'Verify Data and Model'

- script: |
    source .venv/bin/activate
    func azure functionapp publish pre-flight-anomaly-detection --python
  displayName: 'Deploy to Azure Functions'
  env:
    AZURE_FUNCTIONAPP_PUBLISH_PROFILE: $(AZURE_FUNCTIONAPP_PUBLISH_PROFILE)

      X = df[['rpm', 'temperature', 'pressure', 'voltage']]
      preds = model.predict(X)

      anomalies_found = []
      for i, row in df.iterrows():
          if preds[i] == -1:
              anomalies_found.append({
                  'timestamp': row['timestamp'],
                  'rpm': row['rpm'],
                  'temperature': row['temperature'],
                  'pressure': row['pressure'],
                  'voltage': row['voltage']
              })

      if anomalies_found:
          print("ANOMALIES DETECTED:")
          for anomaly in anomalies_found:
              print(f"ERROR at [{anomaly['timestamp']}s]: Abnormal readings - "
                    f"RPM = {anomaly['rpm']}, Temp = {anomaly['temperature']}, "
                    f"Pressure = {anomaly['pressure']}, Voltage = {anomaly['voltage']}")
      else:
          print("Everything is clear for take off")
  displayName: 'Run Anomaly Detection'